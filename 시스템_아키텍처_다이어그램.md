# Panel Insight 시스템 아키텍처 - Mermaid 다이어그램

## 1. 전체 시스템 아키텍처

```mermaid
graph TB
    User[사용자]
    Frontend[React Client<br/>TypeScript + Vite]
    Backend[FastAPI Server<br/>Python 3.13]
    DB[(PostgreSQL<br/>+ pgvector)]
    Embedding[HuggingFace<br/>Sentence-Transformers]
    
    User -->|HTTP 요청| Frontend
    Frontend -->|REST API<br/>JSON| Backend
    Backend -->|SQL<br/>Async| DB
    Backend -->|임베딩 생성| Embedding
    Backend -->|결과 반환| Frontend
    Frontend -->|화면 표시| User
    
    style Frontend fill:#61dafb
    style Backend fill:#009688
    style DB fill:#336791
    style Embedding fill:#ffd700
```

## 2. 백엔드 레이어드 아키텍처

```mermaid
graph TB
    subgraph "API Layer"
        A1[search.py<br/>벡터 검색]
        A2[search_rag.py<br/>RAG 검색]
        A3[panels.py<br/>패널 상세]
        A4[clustering.py<br/>클러스터링]
        A5[health.py<br/>Health Check]
    end
    
    subgraph "Business Logic Layer"
        B1[embeddings.py<br/>임베딩 생성]
        B2[clustering/<br/>피처 파이프라인]
        B3[clustering/<br/>비교 분석]
    end
    
    subgraph "Data Access Layer (DAO)"
        C1[dao_panels.py<br/>패널 데이터]
        C2[dao_embeddings.py<br/>벡터 검색]
        C3[session.py<br/>DB 세션]
    end
    
    subgraph "Database"
        D1[(PostgreSQL<br/>RawData Schema)]
        D2[(pgvector<br/>testcl Schema)]
    end
    
    A1 --> B1
    A1 --> C2
    A2 --> C1
    A3 --> C1
    A4 --> B2
    A4 --> B3
    
    C1 --> C3
    C2 --> C3
    B1 --> C3
    
    C3 --> D1
    C3 --> D2
    
    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style A3 fill:#e3f2fd
    style A4 fill:#e3f2fd
    style A5 fill:#e3f2fd
    style B1 fill:#f3e5f5
    style B2 fill:#f3e5f5
    style B3 fill:#f3e5f5
    style C1 fill:#fff3e0
    style C2 fill:#fff3e0
    style C3 fill:#fff3e0
    style D1 fill:#e8f5e9
    style D2 fill:#e8f5e9
```

## 3. 프론트엔드 컴포넌트 구조

```mermaid
graph TB
    App[App.tsx<br/>루트 컴포넌트]
    
    subgraph "Pages"
        P1[StartPage<br/>메인 검색]
        P2[ResultsPage<br/>검색 결과]
        P3[ClusterLabPage<br/>클러스터 분석]
        P4[ComparePage<br/>비교 분석]
    end
    
    subgraph "Drawers"
        D1[FilterDrawer<br/>필터]
        D2[PanelDetailDrawer<br/>패널 상세]
        D3[ExportDrawer<br/>내보내기]
        D4[PIHistoryDrawer<br/>히스토리]
    end
    
    subgraph "PI Components"
        PC1[PIButton<br/>PICard<br/>PIBadge]
        PC2[PIClusterBadge<br/>PIQuickActionChip]
    end
    
    subgraph "UI Components"
        UI1[button<br/>dialog<br/>drawer]
        UI2[checkbox<br/>slider<br/>tabs]
    end
    
    subgraph "Lib"
        L1[config.ts<br/>API 설정]
        L2[utils.ts<br/>유틸리티]
        L3[history.ts<br/>히스토리]
    end
    
    App --> P1
    App --> P2
    App --> P3
    App --> P4
    App --> D1
    App --> D2
    App --> D3
    App --> D4
    
    P2 --> D1
    P2 --> D2
    P2 --> D3
    
    P1 --> PC1
    P2 --> PC1
    P3 --> PC2
    
    PC1 --> UI1
    D1 --> UI2
    
    P1 --> L1
    P2 --> L1
    P4 --> L3
    
    style App fill:#61dafb
    style P1 fill:#bbdefb
    style P2 fill:#bbdefb
    style P3 fill:#bbdefb
    style P4 fill:#bbdefb
    style D1 fill:#c5e1a5
    style D2 fill:#c5e1a5
    style D3 fill:#c5e1a5
    style D4 fill:#c5e1a5
```

## 4. 검색 흐름 다이어그램

```mermaid
sequenceDiagram
    participant User as 사용자
    participant FE as React Client
    participant API as FastAPI
    participant EMB as Embedding Service
    participant DB as PostgreSQL
    
    User->>FE: 자연어 검색 입력
    User->>FE: 필터 선택
    FE->>API: POST /api/search<br/>{query, filters}
    
    API->>EMB: embed_text(query)
    EMB-->>API: 768차원 벡터
    
    API->>DB: 벡터 검색 (pgvector)<br/>+ 필터 적용
    DB-->>API: 검색 결과
    
    Note over API: RawData JOIN<br/>(나이, 소득 필터)
    
    API->>DB: 필터링된 결과 조회
    DB-->>API: 최종 결과
    
    API-->>FE: JSON 응답<br/>{results, total, pages}
    FE-->>User: 검색 결과 표시
```

## 5. 필터 처리 흐름

```mermaid
flowchart TD
    Start[필터 드로어 열기]
    Input[사용자 필터 입력]
    
    subgraph "프론트엔드"
        Check1[체크박스 상태 업데이트]
        Slider[슬라이더 값 업데이트]
        Apply[적용 버튼 클릭]
        Format[필터 객체 생성]
    end
    
    subgraph "백엔드 - 필터 파싱"
        Parse[필터 파라미터 파싱]
        Split[필터 타입별 분류]
    end
    
    subgraph "1단계: SQL 레벨 필터링"
        SQL1[성별 필터<br/>demographics JSONB]
        SQL2[지역 필터<br/>demographics JSONB]
    end
    
    subgraph "2단계: Python 레벨 필터링"
        Join[RawData 테이블 JOIN]
        Filter1[나이 필터 체크]
        Filter2[소득 필터 체크<br/>문자열 파싱]
        Filter3[퀵폴 필터 체크]
    end
    
    Result[필터링된 결과 반환]
    
    Start --> Input
    Input --> Check1
    Input --> Slider
    Check1 --> Apply
    Slider --> Apply
    Apply --> Format
    
    Format -->|HTTP POST| Parse
    Parse --> Split
    
    Split -->|성별, 지역| SQL1
    Split -->|성별, 지역| SQL2
    SQL1 -->|벡터 검색 결과| Join
    SQL2 -->|벡터 검색 결과| Join
    
    Split -->|나이, 소득, 퀵폴| Join
    Join --> Filter1
    Filter1 --> Filter2
    Filter2 --> Filter3
    Filter3 --> Result
    
    style Start fill:#e1f5fe
    style Format fill:#fff3e0
    style SQL1 fill:#
    style SQL2 fill:#e8f5e9
    style Filter1 fill:#f3e5f5
    style Filter2 fill:#f3e5f5
    style Filter3 fill:#f3e5f5
    style Result fill:#fff9c4
```

## 6. 클러스터링 흐름

```mermaid
sequenceDiagram
    participant User as 사용자
    participant FE as React Client
    participant API as Clustering API
    participant DAO as DAO Layer
    participant ML as ML Service
    participant DB as PostgreSQL
    
    User->>FE: 패널 선택
    FE->>API: POST /api/clustering/run<br/>{panel_ids, algo}
    
    API->>DAO: extract_features_for_clustering
    DAO->>DB: 피처 추출 쿼리
    DB-->>DAO: 원시 피처 데이터
    
    DAO-->>API: 피처 배열
    
    API->>ML: 전처리<br/>(정규화, PCA)
    ML-->>API: 전처리된 피처
    
    API->>ML: K-Means/HDBSCAN 실행
    ML-->>API: 클러스터 라벨
    
    API->>ML: 평가 지표 계산<br/>(Silhouette, CH, DB)
    ML-->>API: 평가 결과
    
    API->>API: 세션 아티팩트 저장
    API-->>FE: {session_id, clusters, metrics}
    FE-->>User: 클러스터 결과 표시
```

## 7. 데이터베이스 스키마 관계

```mermaid
erDiagram
    WELCOME_1ST ||--o{ WELCOME_2ND : "mb_sn"
    WELCOME_1ST ||--o{ QUICK_ANSWER : "mb_sn"
    WELCOME_1ST ||--o{ PANEL_EMBEDDINGS_V : "mb_sn"
    
    WELCOME_1ST {
        string mb_sn PK
        string gender
        string birth_year
        string location
        string detail_location
    }
    
    WELCOME_2ND {
        string mb_sn FK
        jsonb data
        numeric income_personal
        numeric income_household
    }
    
    QUICK_ANSWER {
        string mb_sn FK
        jsonb answers
    }
    
    PANEL_EMBEDDINGS_V {
        string mb_sn PK
        jsonb demographics
        text combined_text
        vector embedding "768차원"
        jsonb categories
    }
    
    CLUSTERING_RESULTS {
        uuid id PK
        string panel_id FK
        int cluster_id
        float confidence
    }
```

## 8. 필터 타입별 처리 방식

```mermaid
flowchart LR
    subgraph "SQL 레벨 필터링"
        A1[성별 필터<br/>demographics JSONB]
        A2[지역 필터<br/>demographics JSONB]
    end
    
    subgraph "Python 레벨 필터링"
        B1[나이 필터<br/>birth_year 계산]
        B2[소득 필터<br/>문자열 파싱]
        B3[퀵폴 필터<br/>JOIN 체크]
    end
    
    Input[필터 객체] --> A1
    Input --> A2
    Input --> B1
    Input --> B2
    Input --> B3
    
    A1 -->|WHERE 절 추가| SQL[SQL 쿼리]
    A2 -->|WHERE 절 추가| SQL
    
    B1 -->|벡터 검색 후| Python[Python 필터링]
    B2 -->|벡터 검색 후| Python
    B3 -->|벡터 검색 후| Python
    
    SQL --> Result[최종 결과]
    Python --> Result
    
    style A1 fill:#e8f5e9
    style A2 fill:#e8f5e9
    style B1 fill:#fff3e0
    style B2 fill:#fff3e0
    style B3 fill:#fff3e0
    style Result fill:#fff9c4
```

## 9. API 엔드포인트 구조

```mermaid
graph TB
    Root[FastAPI App]
    
    subgraph "Search APIs"
        S1[POST /api/search<br/>벡터 검색]
        S2[POST /api/search/rag<br/>RAG 검색]
    end
    
    subgraph "Panel APIs"
        P1[GET /api/panels/{id}<br/>패널 상세]
    end
    
    subgraph "Clustering APIs"
        C1[POST /api/clustering/run<br/>클러스터링 실행]
        C2[POST /api/clustering/compare<br/>그룹 비교]
        C3[POST /api/clustering/umap<br/>UMAP 좌표]
        C4[GET /api/clustering/sessions<br/>세션 목록]
    end
    
    subgraph "Health APIs"
        H1[GET /health<br/>기본 체크]
        H2[GET /health/db<br/>DB 연결]
    end
    
    Root --> S1
    Root --> S2
    Root --> P1
    Root --> C1
    Root --> C2
    Root --> C3
    Root --> C4
    Root --> H1
    Root --> H2
    
    style S1 fill:#e3f2fd
    style S2 fill:#e3f2fd
    style P1 fill:#e3f2fd
    style C1 fill:#f3e5f5
    style C2 fill:#f3e5f5
    style C3 fill:#f3e5f5
    style C4 fill:#f3e5f5
    style H1 fill:#fff3e0
    style H2 fill:#fff3e0
```

## 10. 전체 시스템 상호작용

```mermaid
graph TB
    subgraph "Client Side"
        Browser[브라우저]
        React[React App]
        Components[컴포넌트들]
    end
    
    subgraph "Server Side"
        FastAPI[FastAPI Server]
        
        subgraph "Services"
            Embedding[임베딩 서비스]
            Clustering[클러스터링 서비스]
        end
        
        subgraph "Data Layer"
            DAO[DAO Layer]
            Session[DB 세션 관리]
        end
    end
    
    subgraph "Database"
        PG[(PostgreSQL)]
        Vector[pgvector 확장]
    end
    
    Browser --> React
    React --> Components
    Components -->|HTTP/JSON| FastAPI
    
    FastAPI --> Embedding
    FastAPI --> Clustering
    FastAPI --> DAO
    DAO --> Session
    Session --> PG
    PG --> Vector
    
    Embedding -.->|HuggingFace| Vector
    Clustering -.->|Scikit-learn| PG
    
    style Browser fill:#61dafb
    style React fill:#61dafb
    style FastAPI fill:#009688
    style Embedding fill:#ffd700
    style Clustering fill:#ffd700
    style PG fill:#336791
```

## 11. 시스템 전체 흐름도 (사용자 시나리오)

```mermaid
flowchart TD
    Start([사용자 접속])
    
    subgraph "메인 검색 페이지"
        MainPage[StartPage<br/>메인 화면]
        Query[검색어 입력]
        FilterBtn[필터 버튼 클릭]
    end
    
    subgraph "필터 적용"
        FilterDrawer[FilterDrawer 열기]
        SelectFilter[필터 선택<br/>성별/지역/나이/소득]
        ApplyFilter[적용하고 검색]
    end
    
    subgraph "검색 실행"
        SendRequest[API 요청 전송<br/>POST /api/search]
        CreateEmbedding[임베딩 생성<br/>HuggingFace]
        VectorSearch[벡터 검색<br/>pgvector]
        ApplyFilters[필터 적용<br/>SQL + Python]
        GetResults[결과 조회]
    end
    
    subgraph "결과 표시"
        ResultsPage[ResultsPage<br/>검색 결과]
        Pagination[페이지네이션]
        ViewMode[뷰 모드 전환<br/>테이블/카드]
    end
    
    subgraph "추가 기능"
        PanelDetail[패널 상세 보기]
        ClusterLab[클러스터 분석]
        Compare[비교 분석]
        Export[내보내기]
    end
    
    Start --> MainPage
    MainPage --> Query
    MainPage --> FilterBtn
    
    FilterBtn --> FilterDrawer
    FilterDrawer --> SelectFilter
    SelectFilter --> ApplyFilter
    
    Query --> SendRequest
    ApplyFilter --> SendRequest
    
    SendRequest --> CreateEmbedding
    CreateEmbedding --> VectorSearch
    VectorSearch --> ApplyFilters
    ApplyFilters --> GetResults
    
    GetResults --> ResultsPage
    ResultsPage --> Pagination
    ResultsPage --> ViewMode
    
    ResultsPage --> PanelDetail
    ResultsPage --> ClusterLab
    ResultsPage --> Compare
    ResultsPage --> Export
    
    style Start fill:#e1f5fe
    style MainPage fill:#bbdefb
    style SendRequest fill:#fff3e0
    style CreateEmbedding fill:#ffd700
    style VectorSearch fill:#c5e1a5
    style ResultsPage fill:#e8f5e9
    style PanelDetail fill:#f3e5f5
```

## 12. 검색 및 필터 처리 상세 흐름도

```mermaid
flowchart TD
    UserInput[사용자 입력]
    
    subgraph "프론트엔드 처리"
        ParseInput[입력 파싱]
        BuildFilter[필터 객체 생성]
        FormatRequest[요청 포맷팅]
    end
    
    subgraph "API 라우팅"
        ReceiveRequest[요청 수신<br/>POST /api/search]
        ValidateInput[입력 검증]
        ParseFilters[필터 파싱]
    end
    
    subgraph "임베딩 생성"
        EmbedText[텍스트 → 임베딩<br/>768차원]
        Normalize[벡터 정규화]
    end
    
    subgraph "벡터 검색 1단계"
        SQLFilter[SQL 레벨 필터링<br/>성별/지역]
        VectorQuery[pgvector 쿼리<br/>cosine similarity]
        TopK[상위 K개 결과<br/>유사도 >= 0.9]
    end
    
    subgraph "필터링 2단계"
        JoinRawData[RawData JOIN<br/>나이/소득/퀵폴]
        FilterAge[나이 필터 체크]
        FilterIncome[소득 필터 체크<br/>문자열 파싱]
        FilterQuickpoll[퀵폴 필터 체크]
    end
    
    subgraph "결과 처리"
        Paginate[페이지네이션]
        FormatResponse[응답 포맷팅]
        SendResponse[JSON 응답]
    end
    
    subgraph "프론트엔드 표시"
        RenderResults[결과 렌더링]
        UpdateUI[UI 업데이트]
    end
    
    UserInput --> ParseInput
    ParseInput --> BuildFilter
    BuildFilter --> FormatRequest
    
    FormatRequest --> ReceiveRequest
    ReceiveRequest --> ValidateInput
    ValidateInput --> ParseFilters
    
    ParseFilters --> EmbedText
    EmbedText --> Normalize
    Normalize --> SQLFilter
    
    SQLFilter --> VectorQuery
    VectorQuery --> TopK
    TopK --> JoinRawData
    
    JoinRawData --> FilterAge
    FilterAge --> FilterIncome
    FilterIncome --> FilterQuickpoll
    FilterQuickpoll --> Paginate
    
    Paginate --> FormatResponse
    FormatResponse --> SendResponse
    
    SendResponse --> RenderResults
    RenderResults --> UpdateUI
    
    style UserInput fill:#e1f5fe
    style EmbedText fill:#ffd700
    style VectorQuery fill:#c5e1a5
    style JoinRawData fill:#fff3e0
    style FilterAge fill:#f3e5f5
    style FilterIncome fill:#f3e5f5
    style FilterQuickpoll fill:#f3e5f5
    style UpdateUI fill:#e8f5e9
```

## 13. 클러스터링 전체 흐름도

```mermaid
flowchart TD
    Start([패널 선택])
    
    subgraph "요청 단계"
        SelectPanels[패널 ID 선택]
        SetParams[알고리즘 설정<br/>K-Means/HDBSCAN]
        SendClusterRequest[POST /api/clustering/run]
    end
    
    subgraph "피처 추출"
        QueryFeatures[피처 추출 쿼리<br/>RawData JOIN]
        ExtractNum[숫자 피처<br/>나이, 소득]
        ExtractCat[범주 피처<br/>성별, 지역]
        ExtractText[텍스트 피처<br/>응답, 태그]
    end
    
    subgraph "전처리"
        Normalize[정규화<br/>Spherical Normalization]
        Encode[범주형 인코딩]
        PCA[PCA 적용<br/>선택적]
    end
    
    subgraph "클러스터링"
        RunKMeans[K-Means 실행<br/>또는]
        RunHDBSCAN[HDBSCAN 실행]
        GetLabels[클러스터 라벨]
    end
    
    subgraph "평가"
        CalcSilhouette[Silhouette Score]
        CalcCH[Calinski-Harabasz Index]
        CalcDB[Davies-Bouldin Index]
    end
    
    subgraph "저장 및 반환"
        SaveSession[세션 저장<br/>아티팩트]
        ReturnResults[결과 반환<br/>session_id, labels, metrics]
    end
    
    subgraph "후속 작업"
        UMAP[UMAP 시각화]
        Compare[그룹 비교]
        Export[결과 내보내기]
    end
    
    Start --> SelectPanels
    SelectPanels --> SetParams
    SetParams --> SendClusterRequest
    
    SendClusterRequest --> QueryFeatures
    QueryFeatures --> ExtractNum
    QueryFeatures --> ExtractCat
    QueryFeatures --> ExtractText
    
    ExtractNum --> Normalize
    ExtractCat --> Encode
    ExtractText --> PCA
    
    Normalize --> RunKMeans
    Encode --> RunKMeans
    PCA --> RunKMeans
    
    Normalize --> RunHDBSCAN
    Encode --> RunHDBSCAN
    PCA --> RunHDBSCAN
    
    RunKMeans --> GetLabels
    RunHDBSCAN --> GetLabels
    
    GetLabels --> CalcSilhouette
    GetLabels --> CalcCH
    GetLabels --> CalcDB
    
    CalcSilhouette --> SaveSession
    CalcCH --> SaveSession
    CalcDB --> SaveSession
    
    SaveSession --> ReturnResults
    
    ReturnResults --> UMAP
    ReturnResults --> Compare
    ReturnResults --> Export
    
    style Start fill:#e1f5fe
    style QueryFeatures fill:#fff3e0
    style Normalize fill:#f3e5f5
    style RunKMeans fill:#ffd700
    style RunHDBSCAN fill:#ffd700
    style CalcSilhouette fill:#c5e1a5
    style ReturnResults fill:#e8f5e9
```

## 14. 비교 분석 흐름도

```mermaid
flowchart TD
    Start([그룹 비교 시작])
    
    subgraph "그룹 선택"
        SelectSession[세션 선택<br/>session_id]
        SelectGroup1[그룹 1 선택<br/>cluster_id]
        SelectGroup2[그룹 2 선택<br/>cluster_id]
        SendCompareRequest[POST /api/clustering/compare]
    end
    
    subgraph "데이터 로드"
        LoadSession[세션 아티팩트 로드]
        LoadGroup1[그룹 1 데이터]
        LoadGroup2[그룹 2 데이터]
    end
    
    subgraph "통계 분석"
        subgraph "연속형 피처"
            CalcSMD[SMD 계산<br/>Standardized Mean Difference]
            SortSMD[|SMD| 내림차순 정렬]
        end
        
        subgraph "범주/이진 피처"
            CalcJSD[JSD 계산<br/>Jensen-Shannon Divergence]
            SortJSD[JSD 내림차순 정렬]
        end
    end
    
    subgraph "결과 생성"
        CreateRankings[Rankings 생성]
        ExtractHighlights[Highlights 추출<br/>상위 N개]
        FormatResults[결과 포맷팅]
    end
    
    subgraph "시각화"
        RenderChart[차트 렌더링<br/>Bar/Line]
        ShowTable[비교 테이블]
        Export[내보내기<br/>CSV/PNG]
    end
    
    Start --> SelectSession
    SelectSession --> SelectGroup1
    SelectGroup1 --> SelectGroup2
    SelectGroup2 --> SendCompareRequest
    
    SendCompareRequest --> LoadSession
    LoadSession --> LoadGroup1
    LoadSession --> LoadGroup2
    
    LoadGroup1 --> CalcSMD
    LoadGroup2 --> CalcSMD
    LoadGroup1 --> CalcJSD
    LoadGroup2 --> CalcJSD
    
    CalcSMD --> SortSMD
    CalcJSD --> SortJSD
    
    SortSMD --> CreateRankings
    SortJSD --> CreateRankings
    
    CreateRankings --> ExtractHighlights
    ExtractHighlights --> FormatResults
    
    FormatResults --> RenderChart
    FormatResults --> ShowTable
    FormatResults --> Export
    
    style Start fill:#e1f5fe
    style CalcSMD fill:#ffd700
    style CalcJSD fill:#ffd700
    style CreateRankings fill:#c5e1a5
    style FormatResults fill:#e8f5e9
```

## 15. 패널 상세 조회 흐름도

```mermaid
flowchart TD
    Start([패널 클릭])
    
    subgraph "요청"
        ClickPanel[패널 카드/행 클릭]
        GetPanelId[패널 ID 추출]
        SendRequest[GET /api/panels/{id}]
    end
    
    subgraph "데이터 조회"
        QueryDB[데이터베이스 쿼리]
        JoinW1[welcome_1st JOIN<br/>기본 인구통계]
        JoinW2[welcome_2nd JOIN<br/>상세 응답 JSONB]
        JoinQA[quick_answer JOIN<br/>빠른 응답 JSONB]
        JoinEmb[panel_embeddings_v JOIN<br/>임베딩 정보]
    end
    
    subgraph "데이터 파싱"
        ParseDemographics[인구통계 파싱<br/>성별/나이/지역]
        ParseResponses[응답 이력 파싱<br/>JSONB → 배열]
        ParseTags[태그 파싱<br/>categories JSONB]
        ExtractIncome[소득 정보 추출]
    end
    
    subgraph "표시 준비"
        FormatData[데이터 포맷팅]
        GenerateSummary[AI 요약 생성<br/>선택적]
        PrepareTimeline[타임라인 구성]
    end
    
    subgraph "UI 표시"
        OpenDrawer[PanelDetailDrawer 열기]
        ShowBasic[기본 정보 표시]
        ShowHistory[응답 이력 표시]
        ShowTags[태그 표시]
        ShowSummary[요약 표시]
    end
    
    Start --> ClickPanel
    ClickPanel --> GetPanelId
    GetPanelId --> SendRequest
    
    SendRequest --> QueryDB
    QueryDB --> JoinW1
    QueryDB --> JoinW2
    QueryDB --> JoinQA
    QueryDB --> JoinEmb
    
    JoinW1 --> ParseDemographics
    JoinW2 --> ParseResponses
    JoinEmb --> ParseTags
    JoinW2 --> ExtractIncome
    
    ParseDemographics --> FormatData
    ParseResponses --> FormatData
    ParseTags --> FormatData
    ExtractIncome --> FormatData
    
    FormatData --> GenerateSummary
    FormatData --> PrepareTimeline
    
    GenerateSummary --> OpenDrawer
    PrepareTimeline --> OpenDrawer
    
    OpenDrawer --> ShowBasic
    OpenDrawer --> ShowHistory
    OpenDrawer --> ShowTags
    OpenDrawer --> ShowSummary
    
    style Start fill:#e1f5fe
    style QueryDB fill:#fff3e0
    style ParseDemographics fill:#f3e5f5
    style FormatData fill:#c5e1a5
    style OpenDrawer fill:#e8f5e9
```

## 16. 전체 시스템 워크플로우 (통합)

```mermaid
stateDiagram-v2
    [*] --> 메인페이지: 사용자 접속
    
    메인페이지 --> 검색어입력: 검색 시작
    메인페이지 --> 필터열기: 필터 버튼
    
    검색어입력 --> 필터적용: 필터 선택
    필터열기 --> 필터선택: 드로어 열기
    필터선택 --> 필터적용: 적용 버튼
    
    필터적용 --> API요청: 검색 실행
    검색어입력 --> API요청: 검색 실행
    
    API요청 --> 임베딩생성: 벡터 변환
    임베딩생성 --> 벡터검색: pgvector
    벡터검색 --> 필터적용중: 필터 처리
    
    필터적용중 --> 결과표시: 검색 완료
    
    결과표시 --> 패널상세: 패널 클릭
    결과표시 --> 클러스터링: 클러스터 분석
    결과표시 --> 비교분석: 비교 버튼
    결과표시 --> 내보내기: 내보내기
    
    클러스터링 --> 클러스터결과: 클러스터링 실행
    클러스터결과 --> UMAP시각화: UMAP 생성
    클러스터결과 --> 비교분석: 그룹 선택
    
    비교분석 --> 비교결과: 비교 실행
    비교결과 --> 내보내기: 결과 저장
    
    패널상세 --> 결과표시: 닫기
    클러스터결과 --> 결과표시: 돌아가기
    비교결과 --> 결과표시: 돌아가기
    
    메인페이지 --> [*]: 종료
```

